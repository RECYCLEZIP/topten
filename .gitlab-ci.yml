stages:
    - build
    - test
    - deploy

before_script:
    - export MONGOMS_DOWNLOAD_URL=https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-debian10-4.4.1.tgz
    - export MONGOMS_VERSION=4.4.1

build:
    stage: build
    image: docker:lastest
    services:
        - docker:18.09.7-dind
    script:
        - docker rm $(docker ps -qa --no-trunc --filter "status=exited")
        - docker rmi $(docker images | grep "none" | awk '/ / { print $3 }')
        - docker network rm $(docker network ls | grep "bridge" | awk '/ / { print $1 }')
        - docker rm $(docker ps -qa --no-trunc --filter "status=exited");docker rmi $(docker images | grep "none" | awk '/ / { print $3 }');
        - df -h

test:
    stage: test
    image: node:15-buster
    coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
    script:
        - yarn cache clean && yarn && du -d1 -h $(yarn cache dir)
        - yarn test:ci
    cache:
        - paths:
              - coverage/
    artifacts:
        paths:
            - coverage/
        when: always
        reports:
            junit:
                - junit.xml
            cobertura: coverage/cobertura-coverage.xml

pages:
    stage: deploy
    dependencies:
        - test
    script:
        - mkdir .public
        - cp -r coverage/* .public
        - mv .public public
    artifacts:
        paths:
            - public
    only:
        - dev
